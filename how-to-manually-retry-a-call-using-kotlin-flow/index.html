<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>How to Manually Retry a Call Using Kotlin Flow? - Messias Junior</title><meta name="description" content="Messias Junior. Software engineer. Senior android developer"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/"><meta property="og:title" content="How to Manually Retry a Call Using Kotlin Flow? - Messias Junior "><meta property="og:image" content="https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg"><meta property="og:site_name" content="Messias Junior"><meta property="og:description" content="Messias Junior. Software engineer. Senior android developer"><meta property="og:url" content="https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@pyx_dev"><meta name="twitter:title" content="How to Manually Retry a Call Using Kotlin Flow? - Messias Junior "><meta name="twitter:description" content="Messias Junior. Software engineer. Senior android developer"><meta name="twitter:image" content="https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg"><link rel="shortcut icon" href="https://messiaslima.github.io/media/website/favicon.png" type="image/png"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Dosis:400,600&amp;display=swap" rel="stylesheet"><style>:root{--primary-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--secondary-font:'Dosis',sans-serif}</style><link rel="stylesheet" href="https://messiaslima.github.io/assets/css/fontawesome-all.min.css?v=dbf9d822cefe851ba6f66e1ad57e8987"><link rel="stylesheet" href="https://messiaslima.github.io/assets/css/style.css?v=bdc8e612338c8d45c53bda76a0405a9d"><noscript><link rel="stylesheet" href="https://messiaslima.github.io/assets/css/noscript.css?v=6228c7eee614cd200a2cad8333b439fa"></noscript><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/"},"headline":"How to Manually Retry a Call Using Kotlin Flow?","datePublished":"2022-03-10T16:33","dateModified":"2022-03-10T16:39","image":{"@type":"ImageObject","url":"https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg","height":1920,"width":1280},"description":"Messias Junior. Software engineer. Senior android developer","author":{"@type":"Person","name":"Messias Junior"},"publisher":{"@type":"Organization","name":"Messias Junior"}}</script><style>#wrapper > .bg {
               background-image: url(https://messiaslima.github.io/assets/images/overlay.png), linear-gradient(0deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url(https://messiaslima.github.io/media/website/wallhaven-42op3x.jpg);
           }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3124052078905914" crossorigin="anonymous"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CH2H5CFYLQ"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CH2H5CFYLQ');</script></head><body class="is-preload"><div id="wrapper"><header id="header"><a class="logo" href="https://messiaslima.github.io/">Messias Junior</a></header><nav id="nav"><ul class="links"><li><a href="https://messiaslima.github.io/" title="Home" target="_self">Home</a></li><li><a href="https://messiaslima.github.io/tags/projects/" title="Projects" target="_self">Projects</a></li><li><a href="https://messiaslima.github.io/tags/articles/" target="_self">Articles</a></li><li><a href="https://messiaslima.github.io/about-my-carreer/" target="_self">About my career</a></li></ul><ul class="icons"><li><a href="https://twitter.com/pyx_dev" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li><li><a href="https://www.instagram.com/balrog__/" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li><li><a href="https://www.linkedin.com/in/messias-lima/" class="icon brands fa-linkedin"><span class="label">LinkedIn</span></a></li><li><a href="https://www.youtube.com/channel/UCfZJwrL0quUHAyadsRoNr7A" class="icon brands fa-youtube"><span class="label">YouTube</span></a></li></ul></nav><main id="main"><article class="post"><header class="major"><time datetime="2022-03-10T16:33" class="date">10 March 2022</time><h1>How to Manually Retry a Call Using Kotlin Flow?</h1><p class="post__inner"></p></header><figure class="image main"><img src="https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg" srcset="https://messiaslima.github.io/media/posts/7/responsive/pexels-cottonbro-5053987-xs.jpeg 300w, https://messiaslima.github.io/media/posts/7/responsive/pexels-cottonbro-5053987-sm.jpeg 480w, https://messiaslima.github.io/media/posts/7/responsive/pexels-cottonbro-5053987-md.jpeg 768w, https://messiaslima.github.io/media/posts/7/responsive/pexels-cottonbro-5053987-lg.jpeg 1024w, https://messiaslima.github.io/media/posts/7/responsive/pexels-cottonbro-5053987-xl.jpeg 1360w" sizes="(max-width: 1360px) 100vw, 1360px" loading="lazy" height="1920" width="1280" alt=""></figure><div class="post__inner post__entry"><p id="9012" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">I know that you already faced this scenario:</p><p id="8005" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The user opens a screen, and the application does a network call to retrieve some data to fill the screen. But wait… something weird happened and the call failed. I know that you are a good developer and treated this exception and in this case, the application doesn't crash, it just shows a beautiful error screen… “Ops… something went wrong”. You are using Kotlin flows and decided to put a “Try again” button on the error screen. But… how you can restart the flow?</p><h2 id="a82c" class="jt ju gw cg jv jw jx jy jz ka kb kc kd ic ke id kf if kg ig kh ii ki ij kj kk et">First implementation: without retry</h2><p>Your view model will look more or less like this:</p><p><script src="https://gist.github.com/MessiasLima/8956d82aef89651aa682be73a695c384.js"></script></p><p id="9cbb" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">Here I made 2 main things</p><ul><li id="5284" class="ks kt gw iz b ja jb jd je jg ku jk kv jo kw js kx ky kz la et" data-selectable-paragraph="">I created sealed classes to represent each screen state (you can read a little more about this approach <a class="au lb" href="https://proandroiddev.com/modelling-ui-state-on-android-26314a5975b9" rel="noopener ugc nofollow" target="_blank">here</a> ).</li><li id="55e1" class="ks kt gw iz b ja lc jd ld jg le jk lf jo lg js kx ky kz la et" data-selectable-paragraph="">I exposed a Flow that fetch the store list and wrap it in a <code class="lh li lj lk ll b">UiState</code> class.</li></ul><p id="4d42" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">This approach is very good because the flow will start as soon as it gets an observer as you can see in the example below. The example is made with Jetpack Compose but it can also be used with the regular View framework.</p><p data-selectable-paragraph=""><script src="https://gist.github.com/MessiasLima/b9533a7172147017559992a6d6c7d6bc.js"></script></p><p>However, this approach doesn't provide us with an easy way to restart the flow if something went wrong on the first try. The Flow framework has a way to set up a retry behaviour but this happens automatically, not by the user command. You can see more about the built-in approach <a class="au lb" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/retry.html" rel="noopener ugc nofollow" target="_blank">here</a>.</p><h2 id="36a4" class="jt ju gw cg jv jw jx jy jz ka kb kc kd ic ke id kf if kg ig kh ii ki ij kj kk et">Giving our Flow the power to restart</h2><p>I spent some time thinking about how to do it. Read some articles and reached on the following implementation:</p><p><script src="https://gist.github.com/MessiasLima/6d3ee3d14ed9bdfc29ebb862eb74bb3d.js"></script></p><p id="771f" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The point of this implementation is to wrap the main flow on an external flow that starts with a <code class="lh li lj lk ll b">MutableStateFlow</code>. This way, we can use the event of the state changing to start the main flow again.</p><p id="0737" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">To make it more convenient, I also create a class called <code class="lh li lj lk ll b">RetryTrigger</code> to control when the flow should start again and hold the states: <code class="lh li lj lk ll b">RETRYING</code> and <code class="lh li lj lk ll b">IDLE</code>.</p><p id="ad24" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The state <code class="lh li lj lk ll b">RETRYING</code> means that the flow should start. The initial state is <code class="lh li lj lk ll b">RETRYING</code> because we need the first call to run normally. After the first call, the state is changed to <code class="lh li lj lk ll b">IDLE</code> (line 12).</p><p id="2d70" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The state <code class="lh li lj lk ll b">IDLE</code> means that the flow was already started and returned the first value (it could be a success or an error response). We are filtering the <code class="lh li lj lk ll b">MutableStateFlow</code> to start the main flow only when the state is <code class="lh li lj lk ll b">RETRYING</code> (line 10).</p><p id="6285" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">Last but not least we have the method <code class="lh li lj lk ll b">retry()</code> on <code class="lh li lj lk ll b">RetryTrigger</code>. It set the mutable state to <code class="lh li lj lk ll b">RETRYING</code> again and the main flow is started again.</p><h2 id="c698" class="jt ju gw cg jv jw jx jy jz ka kb kc kd ic ke id kf if kg ig kh ii ki ij kj kk et">The final implementation </h2><p><script src="https://gist.github.com/MessiasLima/edd08036bd5d0be8347be722a8823190.js"></script></p><div class="gp gq gr gs gt"><p id="6259" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">On this new implementation we have the following:</p><ul><li id="205f" class="ks kt gw iz b ja jb jd je jg ku jk kv jo kw js kx ky kz la et" data-selectable-paragraph="">I created an instance of <code class="lh li lj lk ll b">RetryTrigger</code> and passed it as the first argument on the retryable flow creation method.</li><li id="7277" class="ks kt gw iz b ja lc jd ld jg le jk lf jo lg js kx ky kz la et" data-selectable-paragraph="">The main flow was wrapped in a retryable flow. I decided to pass this flow inside a lambda. I could even make this method inline, but these are implementation decisions, and is up to you to decide what fits better to your project.</li><li id="d6cd" class="ks kt gw iz b ja lc jd ld jg le jk lf jo lg js kx ky kz la et" data-selectable-paragraph="">Now there is a <code class="lh li lj lk ll b">tryAgain()</code> method that calls <code class="lh li lj lk ll b">retryTrigger.retry()</code>. This method should be called when the user presses the “try again” button on the error screen.</li></ul></div><div class="o ct lm ln lo lp" role="separator">This is a solution to a problem that I was facing. It probably can help other developers too. Thank you for reading and see you in the next article!</div></div><footer class="post__inner post__footer"><p class="post__last-updated">This article was updated on 10 March 2022</p><div class="post__share-tag-container"><div class="post__tag"><h3>Tagged in:</h3><ul><li><a href="https://messiaslima.github.io/tags/android/">android</a></li><li><a href="https://messiaslima.github.io/tags/articles/">Articles</a></li><li><a href="https://messiaslima.github.io/tags/jetpack/">Jetpack</a></li><li><a href="https://messiaslima.github.io/tags/kotlin/">kotlin</a></li></ul></div><div class="post__share"><button class="post__share-button js-post__share-button icon" aria-label="Share button"><i class="fas fa-share-alt"></i></button><div class="post__share-popup js-post__share-popup"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share icon brands fa-facebook-f" rel="nofollow noopener noreferrer"><span class="label">Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F&amp;via=%40pyx_dev&amp;text=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F" class="js-share icon brands fa-twitter" rel="nofollow noopener noreferrer"><span class="label">Twitter</span> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F&amp;media=https%3A%2F%2Fmessiaslima.github.io%2Fmedia%2Fposts%2F7%2Fpexels-cottonbro-5053987.jpeg&amp;description=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F" class="js-share icon brands fa-pinterest" rel="nofollow noopener noreferrer"><span class="label">Pinterest</span> </a><a href="https://mix.com/add?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share icon brands fa-mix" rel="nofollow noopener noreferrer"><span class="label">Mix</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share icon brands fa-linkedin" rel="nofollow noopener noreferrer"><span class="label">LinkedIn</span> </a><a href="https://buffer.com/add?text=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F&amp;url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share icon brands fa-buffer" rel="nofollow noopener noreferrer"><span class="label">Buffer</span> </a><a href="https://api.whatsapp.com/send?text=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share icon brands fa-whatsapp" rel="nofollow noopener noreferrer"><span class="label">WhatsApp</span></a></div></div></div><div class="post__bio"><div><h3><a href="https://messiaslima.github.io/authors/messias-junior/" class="invert" rel="author">Messias Junior</a></h3></div></div></footer></article><div class="comments"><div class="post__inner"><h2>Comments</h2><div id="disqus_thread"></div><script>var disqus_config = function () {
                       this.page.url = 'https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/';
                       this.page.identifier = '7';
                   };
                   var disqus_element_to_check = document.getElementById('disqus_thread');
               
                   if ('IntersectionObserver' in window) {
                       var iObserver = new IntersectionObserver(
                           (entries, observer) => {
                               entries.forEach(entry => {
                                   if (entry.intersectionRatio >= 0.1) {
                                       (function () {
                                           var d = document, s = d.createElement('script');
                                           s.src = 'https://'+'messias-lima'.trim()+'.disqus.com/embed.js';
                                           s.setAttribute('data-timestamp', +new Date());
                                           (d.head || d.body).appendChild(s);
                                       })();
                                       observer.unobserve(entry.target);
                                   }
                               });
                           },
                           {
                               threshold: [0, 1]
                           }
                       );
               
                       iObserver.observe(disqus_element_to_check);
                   } else {
                       (function () {
                           var d = document, s = d.createElement('script');
                           s.src = 'https://'+'messias-lima'.trim()+'.disqus.com/embed.js';
                           s.setAttribute('data-timestamp', +new Date());
                           (d.head || d.body).appendChild(s);
                       })();
                   }</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></main><footer id="copyright"><ul><li>Powered by <a href="https://getpublii.com" target="_blank" rel="noopener">Publii</a></li><li><a href="comment-policy">Comment policy</a></li></ul></footer></div><script src="https://messiaslima.github.io/assets/js/jquery.min.js?v=7c14a783dfeb3d238ccd3edd840d82ee"></script><script src="https://messiaslima.github.io/assets/js/jquery.scrollex.min.js?v=f89065e3d988006af9791b44561d7c90"></script><script src="https://messiaslima.github.io/assets/js/jquery.scrolly.min.js?v=1ed5a78bde1476875a40f6b9ff44fc14"></script><script src="https://messiaslima.github.io/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://messiaslima.github.io/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://messiaslima.github.io/assets/js/util.min.js?v=4201a626f8c9b614a663b3a1d7d82615"></script><script src="https://messiaslima.github.io/assets/js/main.min.js?v=149e72e3ae18744a477b480b19e0c6da"></script><script>/*<![CDATA[*/var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};/*]]>*/</script></body></html>