<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>How to Manually Retry a Call Using Kotlin Flow? - Messias Junior</title><meta name="description" content="Messias Junior. Software engineer. Senior android developer"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/"><meta property="og:title" content="How to Manually Retry a Call Using Kotlin Flow? - Messias Junior "><meta property="og:image" content="https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg"><meta property="og:image:width" content="1280"><meta property="og:image:height" content="1920"><meta property="og:site_name" content="Messias Junior"><meta property="og:description" content="Messias Junior. Software engineer. Senior android developer"><meta property="og:url" content="https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/"><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@pyx_dev"><meta name="twitter:title" content="How to Manually Retry a Call Using Kotlin Flow? - Messias Junior "><meta name="twitter:description" content="Messias Junior. Software engineer. Senior android developer"><meta name="twitter:image" content="https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg"><link rel="stylesheet" href="https://messiaslima.github.io/assets/css/style.css?v=89806b0a5f0a604ad10c85d0ccf74c9d"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://messiaslima.github.io/how-to-manually-retry-a-call-using-kotlin-flow/"},"headline":"How to Manually Retry a Call Using Kotlin Flow?","datePublished":"2022-03-10T16:33","dateModified":"2022-03-10T16:39","image":{"@type":"ImageObject","url":"https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg","height":1920,"width":1280},"description":"Messias Junior. Software engineer. Senior android developer","author":{"@type":"Person","name":"Messias Junior","url":"https://messiaslima.github.io/authors/messias-junior/"},"publisher":{"@type":"Organization","name":"Messias Junior"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3124052078905914" crossorigin="anonymous"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CH2H5CFYLQ"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CH2H5CFYLQ');</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://messiaslima.github.io/">Messias Junior</a></header><main><article class="post"><div class="hero"><figure class="hero__image hero__image--overlay"><img src="https://messiaslima.github.io/media/posts/7/pexels-cottonbro-5053987.jpeg" loading="eager" height="1920" width="1280" alt=""></figure><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2022-03-10T16:33">March 10, 2022</time></div><h1>How to Manually Retry a Call Using Kotlin Flow?</h1><div class="post__meta post__meta--author"><img src="https://messiaslima.github.io/media/website/me.jpeg" loading="eager" height="460" width="460" class="post__author-thumb" alt="Messias Junior"> <a href="https://messiaslima.github.io/authors/messias-junior/" class="feed__author">Messias Junior</a></div></div></header></div><div class="wrapper post__entry"><p id="9012" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">I know that you already faced this scenario:</p><p id="8005" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The user opens a screen, and the application does a network call to retrieve some data to fill the screen. But wait… something weird happened and the call failed. I know that you are a good developer and treated this exception and in this case, the application doesn't crash, it just shows a beautiful error screen… “Ops… something went wrong”. You are using Kotlin flows and decided to put a “Try again” button on the error screen. But… how you can restart the flow?</p><h2 id="a82c" class="jt ju gw cg jv jw jx jy jz ka kb kc kd ic ke id kf if kg ig kh ii ki ij kj kk et">First implementation: without retry</h2><p>Your view model will look more or less like this:</p><p><script src="https://gist.github.com/MessiasLima/8956d82aef89651aa682be73a695c384.js"></script></p><p id="9cbb" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">Here I made 2 main things</p><ul><li id="5284" class="ks kt gw iz b ja jb jd je jg ku jk kv jo kw js kx ky kz la et" data-selectable-paragraph="">I created sealed classes to represent each screen state (you can read a little more about this approach <a class="au lb" href="https://proandroiddev.com/modelling-ui-state-on-android-26314a5975b9" rel="noopener ugc nofollow" target="_blank">here</a> ).</li><li id="55e1" class="ks kt gw iz b ja lc jd ld jg le jk lf jo lg js kx ky kz la et" data-selectable-paragraph="">I exposed a Flow that fetch the store list and wrap it in a <code class="lh li lj lk ll b">UiState</code> class.</li></ul><p id="4d42" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">This approach is very good because the flow will start as soon as it gets an observer as you can see in the example below. The example is made with Jetpack Compose but it can also be used with the regular View framework.</p><p data-selectable-paragraph=""><script src="https://gist.github.com/MessiasLima/b9533a7172147017559992a6d6c7d6bc.js"></script></p><p>However, this approach doesn't provide us with an easy way to restart the flow if something went wrong on the first try. The Flow framework has a way to set up a retry behaviour but this happens automatically, not by the user command. You can see more about the built-in approach <a class="au lb" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/retry.html" rel="noopener ugc nofollow" target="_blank">here</a>.</p><h2 id="36a4" class="jt ju gw cg jv jw jx jy jz ka kb kc kd ic ke id kf if kg ig kh ii ki ij kj kk et">Giving our Flow the power to restart</h2><p>I spent some time thinking about how to do it. Read some articles and reached on the following implementation:</p><p><script src="https://gist.github.com/MessiasLima/6d3ee3d14ed9bdfc29ebb862eb74bb3d.js"></script></p><p id="771f" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The point of this implementation is to wrap the main flow on an external flow that starts with a <code class="lh li lj lk ll b">MutableStateFlow</code>. This way, we can use the event of the state changing to start the main flow again.</p><p id="0737" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">To make it more convenient, I also create a class called <code class="lh li lj lk ll b">RetryTrigger</code> to control when the flow should start again and hold the states: <code class="lh li lj lk ll b">RETRYING</code> and <code class="lh li lj lk ll b">IDLE</code>.</p><p id="ad24" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The state <code class="lh li lj lk ll b">RETRYING</code> means that the flow should start. The initial state is <code class="lh li lj lk ll b">RETRYING</code> because we need the first call to run normally. After the first call, the state is changed to <code class="lh li lj lk ll b">IDLE</code> (line 12).</p><p id="2d70" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">The state <code class="lh li lj lk ll b">IDLE</code> means that the flow was already started and returned the first value (it could be a success or an error response). We are filtering the <code class="lh li lj lk ll b">MutableStateFlow</code> to start the main flow only when the state is <code class="lh li lj lk ll b">RETRYING</code> (line 10).</p><p id="6285" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">Last but not least we have the method <code class="lh li lj lk ll b">retry()</code> on <code class="lh li lj lk ll b">RetryTrigger</code>. It set the mutable state to <code class="lh li lj lk ll b">RETRYING</code> again and the main flow is started again.</p><h2 id="c698" class="jt ju gw cg jv jw jx jy jz ka kb kc kd ic ke id kf if kg ig kh ii ki ij kj kk et">The final implementation </h2><p><script src="https://gist.github.com/MessiasLima/edd08036bd5d0be8347be722a8823190.js"></script></p><div class="gp gq gr gs gt"><p id="6259" class="pw-post-body-paragraph ix iy gw iz b ja jb hx jc jd je ia jf jg jh ji jj jk jl jm jn jo jp jq jr js gp et" data-selectable-paragraph="">On this new implementation we have the following:</p><ul><li id="205f" class="ks kt gw iz b ja jb jd je jg ku jk kv jo kw js kx ky kz la et" data-selectable-paragraph="">I created an instance of <code class="lh li lj lk ll b">RetryTrigger</code> and passed it as the first argument on the retryable flow creation method.</li><li id="7277" class="ks kt gw iz b ja lc jd ld jg le jk lf jo lg js kx ky kz la et" data-selectable-paragraph="">The main flow was wrapped in a retryable flow. I decided to pass this flow inside a lambda. I could even make this method inline, but these are implementation decisions, and is up to you to decide what fits better to your project.</li><li id="d6cd" class="ks kt gw iz b ja lc jd ld jg le jk lf jo lg js kx ky kz la et" data-selectable-paragraph="">Now there is a <code class="lh li lj lk ll b">tryAgain()</code> method that calls <code class="lh li lj lk ll b">retryTrigger.retry()</code>. This method should be called when the user presses the “try again” button on the error screen.</li></ul></div><div class="o ct lm ln lo lp" role="separator">This is a solution to a problem that I was facing. It probably can help other developers too. Thank you for reading and see you in the next article!</div></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on March 10, 2022</p><ul class="post__tag"><li><a href="https://messiaslima.github.io/tags/android/">android</a></li><li><a href="https://messiaslima.github.io/tags/articles/">Articles</a></li><li><a href="https://messiaslima.github.io/tags/jetpack/">Jetpack</a></li><li><a href="https://messiaslima.github.io/tags/kotlin/">kotlin</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F&amp;via=%40pyx_dev&amp;text=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F&amp;media=https%3A%2F%2Fmessiaslima.github.io%2Fmedia%2Fposts%2F7%2Fpexels-cottonbro-5053987.jpeg&amp;description=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F" class="js-share pinterest" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#pinterest"/></svg> <span>Pinterest</span> </a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=How%20to%20Manually%20Retry%20a%20Call%20Using%20Kotlin%20Flow%3F https%3A%2F%2Fmessiaslima.github.io%2Fhow-to-manually-retry-a-call-using-kotlin-flow%2F" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div><div class="post__bio bio"><img src="https://messiaslima.github.io/media/website/me.jpeg" loading="lazy" height="460" width="460" class="bio__avatar" alt="Messias Junior"><div><h3 class="bio__name"><a href="https://messiaslima.github.io/authors/messias-junior/" rel="author">Messias Junior</a></h3><div class="bio__desc"><p>Android and Kotlin developer</p></div></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://messiaslima.github.io/comment-policy/" class="post__nav-link" rel="prev"><span>Previous</span> Comment Policy</a></div></div></nav></main><footer class="footer"><div class="footer__social"></div><div class="footer__copyright"><p>Made with ❤️</p></div><button onclick="backToTopFunction()" id="backToTop" class="footer__bttop" aria-label="Back to top" title="Back to top"><svg><use xlink:href="https://messiaslima.github.io/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script defer="defer" src="https://messiaslima.github.io/assets/js/scripts.min.js?v=f47c11534595205f20935f0db2a62a85"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.top'};</script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>